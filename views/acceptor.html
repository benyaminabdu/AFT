<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Payment Acceptor</title>
        <script src="{{ clientLibrary }}" integrity="{{ clientLibraryIntegrity }}" crossorigin="anonymous"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                background: #ffffff;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                color: #000000;
            }

            .container {
                background: #ffffff;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
                padding: 40px;
                max-width: 600px;
                width: 100%;
                animation: fadeIn 0.5s ease-in;
                border: 1px solid #e0e0e0;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            h1 {
                color: #000000;
                font-size: 32px;
                font-weight: 700;
                margin-bottom: 8px;
                text-align: center;
                letter-spacing: -0.5px;
            }

            .subtitle {
                text-align: center;
                color: #666666;
                margin-bottom: 32px;
                font-size: 14px;
            }

            #errors-output {
                margin-bottom: 24px;
                min-height: 24px;
            }

            #errors-output div {
                background: #f5f5f5;
                border: 1px solid #d0d0d0;
                border-radius: 8px;
                padding: 12px 16px;
                color: #000000;
                font-size: 14px;
                line-height: 1.5;
            }

            #errors-output small {
                display: block;
                margin-top: 8px;
                font-size: 12px;
                opacity: 0.7;
            }

            #my-sample-form {
                width: 100%;
            }

            .form-group {
                margin-bottom: 24px;
            }

            .form-group label {
                display: block;
                font-weight: 600;
                color: #000000;
                margin-bottom: 8px;
                font-size: 14px;
                letter-spacing: 0.3px;
            }

            .form-control {
                width: 100%;
                padding: 12px 16px;
                border: 1px solid #d0d0d0;
                border-radius: 8px;
                font-size: 16px;
                transition: all 0.3s ease;
                background: white;
                color: #000000;
                font-family: inherit;
            }

            .form-control:focus {
                outline: none;
                border-color: #808080;
                box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
                background: #fafafa;
            }

            .form-control::placeholder {
                color: #999999;
            }

            .form-row {
                display: flex;
                gap: 16px;
                margin-bottom: 24px;
            }

            .form-row .form-group {
                flex: 1;
                margin-bottom: 0;
            }

            #pay-button {
                width: 100%;
                padding: 14px 24px;
                background: #000000;
                color: white;
                border: 1px solid #000000;
                border-radius: 8px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                margin-top: 0;
            }

            #pay-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
                background: #1a1a1a;
            }

            #pay-button:active {
                transform: translateY(0);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                background: #000000;
            }

            .microform-field {
                border: 1px solid #d0d0d0;
                border-radius: 8px;
                padding: 12px 16px;
                background: white;
                transition: border-color 0.2s, box-shadow 0.2s;
                height: 48px;
                display: flex;
                align-items: center;
                overflow: hidden;
            }

            .microform-field iframe {
                height: 100% !important;
                border: none !important;
            }

            .microform-field.focused {
                border-color: #808080;
                box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
                background: #fafafa;
            }

            .microform-field.invalid {
                border-color: #808080;
            }

            .microform-field.valid {
                border-color: #808080;
            }

            @media (max-width: 640px) {
                .container {
                    padding: 24px;
                }

                h1 {
                    font-size: 24px;
                }

                .form-row {
                    flex-direction: column;
                    gap: 0;
                }

                .form-row .form-group {
                    margin-bottom: 24px;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Payment Acceptor</h1>
            <p class="subtitle">Secure payment processing</p>
            <div id="errors-output" role="alert"></div>
            
            <form action="{{ path_for('transientToken') }}" id="my-sample-form" method="post">
                <input type="hidden" name="amount" value="{{ amount }}">
                <input type="hidden" name="reference" value="{{ reference }}">
                
                <div class="form-group">
                    <label for="cardholderName">Name</label>
                    <input id="cardholderName" class="form-control" name="cardholderName" placeholder="Name on the card">
                </div>
                
                <div class="form-group">
                    <label id="cardNumber-label">Card Number</label>
                    <div id="number-container" class="microform-field"></div>
                </div>
                
                <div class="form-group">
                    <label for="securityCode-container">Security Code</label>
                    <div id="securityCode-container" class="microform-field"></div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="expMonth">Expiry month</label>
                        <select id="expMonth" class="form-control">
                            <option>01</option>
                            <option>02</option>
                            <option>03</option>
                            <option>04</option>
                            <option>05</option>
                            <option>06</option>
                            <option>07</option>
                            <option>08</option>
                            <option>09</option>
                            <option>10</option>
                            <option>11</option>
                            <option>12</option>
                        </select>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="expYear">Expiry year</label>
                        <select id="expYear" class="form-control">
                            <option>2026</option>
                            <option>2027</option>
                            <option>2028</option>
                            <option>2029</option>
                            <option>2030</option>
                            <option>2031</option>
                            <option>2032</option>
                            <option>2033</option>
                            <option>2034</option>
                            <option>2035</option>
                            <option>2036</option>
                            <option>2037</option>
                            <option>2038</option>
                            <option>2039</option>
                            <option>2040</option>
                        </select>
                    </div>
                </div>

                <button type="button" id="pay-button" class="btn btn-primary">Pay</button>
                <input type="hidden" id="flexresponse" name="flexresponse">
            </form>


        <script>
            // Capture context from server (JWT token string)
            const captureContext = "{{ captureContext|e('js') }}";
            
            // Wait for Flex SDK to load
            if (typeof Flex !== 'undefined') {
                initializeMicroform();
            } else {
                // If script hasn't loaded yet, wait for it
                window.addEventListener('load', function() {
                    if (typeof Flex !== 'undefined') {
                        initializeMicroform();
                    } else {
                        document.getElementById('errors-output').innerHTML = 
                            '<div>Error: Flex SDK failed to load. Please refresh the page.</div>';
                    }
                });
            }
            
            function initializeMicroform() {
                try {
                    // Create Flex instance with capture context
                    const flex = new Flex(captureContext);
                    
                    // Define styles for the microform fields - black and white theme
                    const styles = {
                        input: {
                            fontSize: '16px',
                            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
                            color: '#000000',
                            letterSpacing: '0.02em'
                        },
                        ':focus': {
                            color: '#000000'
                        },
                        '::placeholder': {
                            color: '#999999'
                        },
                        ':disabled': {
                            cursor: 'not-allowed'
                        },
                        valid: {
                            color: '#000000'
                        },
                        invalid: {
                            color: '#000000'
                        }
                    };
                    
                    // Create microform instance with styles
                    const microform = flex.microform("card", { styles: styles });
                    
                    // Create and attach card number field
                    const number = microform.createField('number', { 
                        placeholder: 'Enter card number'
                    });
                    number.load('#number-container');
                    
                    // Create and attach security code (CVN) field
                    const securityCode = microform.createField('securityCode', { 
                        placeholder: 'CVV' 
                    });
                    securityCode.load('#securityCode-container');
                    
                    // Sync focus states for card number
                    number.on('focus', function() {
                        document.querySelector('#number-container').classList.add('focused');
                    });
                    
                    number.on('blur', function() {
                        document.querySelector('#number-container').classList.remove('focused');
                    });
                    
                    number.on('change', function(data) {
                        const container = document.querySelector('#number-container');
                        container.classList.toggle('invalid', !data.valid && data.value !== '');
                        container.classList.toggle('valid', data.valid);
                    });
                    
                    // Sync focus states for security code
                    securityCode.on('focus', function() {
                        document.querySelector('#securityCode-container').classList.add('focused');
                    });
                    
                    securityCode.on('blur', function() {
                        document.querySelector('#securityCode-container').classList.remove('focused');
                    });
                    
                    securityCode.on('change', function(data) {
                        const container = document.querySelector('#securityCode-container');
                        container.classList.toggle('invalid', !data.valid && data.value !== '');
                        container.classList.toggle('valid', data.valid);
                    });
                    
                    // Handle form submission
                    document.getElementById('pay-button').addEventListener('click', function() {
                        handlePaymentSubmission(microform, number, securityCode);
                    });
                    
                } catch (error) {
                    console.error('Error initializing microform:', error);
                    document.getElementById('errors-output').innerHTML = 
                        '<div>Error initializing payment form: ' + error.message + '</div>';
                }
            }
            
            function handlePaymentSubmission(microform, number, securityCode) {
                const errorsOutput = document.getElementById('errors-output');
                errorsOutput.innerHTML = '';
                
                // Get form values
                const cardholderName = document.getElementById('cardholderName').value.trim();
                const expMonthValue = document.getElementById('expMonth').value;
                const expYearValue = document.getElementById('expYear').value;
                
                // Validate cardholder name
                if (!cardholderName || cardholderName === '') {
                    errorsOutput.innerHTML = '<div>Please enter the cardholder name.</div>';
                    return;
                }
                
                // Validate expiration month
                const expMonthInt = parseInt(expMonthValue, 10);
                if (!expMonthValue || isNaN(expMonthInt) || expMonthInt < 1 || expMonthInt > 12) {
                    errorsOutput.innerHTML = '<div>Please select a valid expiration month.</div>';
                    return;
                }
                // Format expiration month as 2-digit string: "01" to "12"
                const expMonth = String(expMonthInt).padStart(2, '0');
                
                // Validate expiration year
                const expYearInt = parseInt(expYearValue, 10);
                if (!expYearValue || isNaN(expYearInt) || expYearInt < 2020) {
                    errorsOutput.innerHTML = '<div>Please select a valid expiration year.</div>';
                    return;
                }
                // Format expiration year as 4-digit string: "2024", "2025", etc.
                const expYear = String(expYearInt);
                
                // Create tokenization options with proper formatting
                const options = {
                    expirationMonth: expMonth,  // Two-digit string: "01" to "12"
                    expirationYear: expYear,    // Four-digit string: "2024", "2025", etc.
                    cardholderName: cardholderName
                };
                
                // Create transient token
                microform.createToken(options, function(err, token) {
                    if (err) {
                        // Handle errors with detailed information
                        let errorMessage = 'An error occurred while processing your payment.';
                        if (err.message) {
                            errorMessage = err.message;
                        } else if (err.reason) {
                            errorMessage = err.reason;
                        }
                        
                        // Add details if available
                        if (err.details && err.details.length > 0) {
                            errorMessage += '<br><small>Details: ' + JSON.stringify(err.details) + '</small>';
                        }
                        
                        errorsOutput.innerHTML = '<div>' + errorMessage + '</div>';
                        console.error('Token creation error:', err);
                        console.error('Token options used:', options);
                        return;
                    }
                    
                    // Success - token created
                    console.log('Transient token created:', token);
                    
                    // Set the token in the hidden field
                    document.getElementById('flexresponse').value = JSON.stringify(token);
                    
                    // Submit the form (you can also make an AJAX call here)
                    document.getElementById('my-sample-form').submit();
                });
            }
        </script>
        </div>
    </body>
</html>